"use strict";function _classCallCheck(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,n){for(var t=0;t<n.length;t++){var a=n[t];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(n,t,a){return t&&e(n.prototype,t),a&&e(n,a),n}}(),Qtree=function(){function e(n,t,a){_classCallCheck(this,e);var i={branchFormatter:'<div class="QTree-branch">\n                          <span class="tree-content name" name></span>\n                          <div class="edit-container"><span class="btn edit-btn">编辑</span></div>\n                        </div>',limit:"auto",switchClass:".switch",icon:"",openID:"",branchClickEvent:"",renderData:["name"],openBranch:0};this.setting=a?Object.assign(i,a):i,this.nodeData=t,this.container=$(n),this.init()}return _createClass(e,[{key:"init",value:function(){this.initData(),this.createTree(),this.setSwitchEvent()}},{key:"initData",value:function(){if(!this.nodeData.find(function(e){return 0==e.id})){this.nodeData.splice(0,0,{id:"0",pid:"",name:"root",open:!0})}this.setOpenBranchArr(),this.sortNodes(this.nodeData)}},{key:"setOpenBranchArr",value:function(){var e=Number(this.setting.openBranch);if(e||Math.floor(e)==e){var n=[];this.findOpenBranch(e,null,n),this.setting.openBranch=n}}},{key:"findOpenBranch",value:function(e,n,t){if(0==e)return t.push(e),"0";if(""!==n){if(n){var a=this.nodeData.find(function(e){return e.id===n});return t.push(a.id),this.findOpenBranch(e,a.pid,t)}var i=this.nodeData.find(function(n){return n.id==e});return t.push(e),this.findOpenBranch(e,i.pid,t)}}},{key:"sortNodes",value:function(e){function n(e,i,r,c){e&&e.child.forEach(function(c,h){e.child[h].sortID=i+e.child[h].sortID,r.push(e.child[h]);var s=t.setting.openBranch.find(function(n){return n==e.child[h].id}),d=t.nodeData.find(function(n){return n.pid===e.child[h].id});e.child[h].open=void 0!=s&&void 0!=d,n(a[e.child[h].id],e.child[h].sortID,r)})}var t=this;!function(e){var i=[];n((a=function(e){if(e){for(var n={},t=0;t<e.length;t++)if(n[e[t].pid]){var a=1*n[e[t].pid].i+1;n[e[t].pid].i=a,e[t].sortID=1*a<10?"000"+a:1*a>100?"00"+a:1*a>1e3?a:"0"+a,n[e[t].pid].child.push(e[t])}else n[e[t].pid]={},n[e[t].pid].i=1,n[e[t].pid].child=[],e[t].sortID="0001",n[e[t].pid].child.push(e[t]);return n}}(e))[""],"",i),t.nodeData=i}(e=e);var a=null}},{key:"createTree",value:function(){var e=this,n=$(document.createDocumentFragment());this.nodeData.forEach(function(t,a){t.pid?(n.find("#children_"+t.pid).append(e.createBranch(t)),n.find("#container_"+t.id).append(e.createBranchContainer(t.id,t.open))):n.append(e.createBranchContainer(t.id,t.open))}),this.container.empty().append(n)}},{key:"createBranchContainer",value:function(e,n){return'<div class="QTree-children-container '+(n?"":"QTree-hide")+'" id="children_'+e+'"></div>'}},{key:"createBranch",value:function(e){var n=$(this.setting.branchFormatter);n.data("treeData",e);var t=this.createEmptySpan(e.sortID);this.loadBranchData(n,e);var a=this.createSwitch(e);n.prepend(a),n.prepend(t),n.attr("id",e.id),n.hasClass("QTree-branch")||n.addClass("QTree-branch");var i=$('<div class="QTree-branch-container" id="container_'+e.id+'"></div>');return i.append(n),i}},{key:"loadBranchData",value:function(e,n){var t=this,a=this;e.children().each(function(e,i){t.setting.renderData.forEach(function(e,t){i.hasAttribute(e)&&n[e]&&(i.innerHTML=n[e])}),$(i).children().length&&a.loadBranchData($(i),n)})}},{key:"hasChildren",value:function(e){return!!this.nodeData.find(function(n,t){return n.pid===e})}},{key:"createSwitch",value:function(e){return void 0!=this.nodeData.find(function(n){return n.pid==e.id})?this.createSwitchString(e.open):'<span class="empty-span"></span>'}},{key:"createSwitchString",value:function(e){return e?'<i class="switch minus-btn" data-switch="true"></i>':'<i class="switch plus-btn" data-switch="false"></i>'}},{key:"createEmptySpan",value:function(e,n){for(var t=n?e:this.countIndex(e),a="",i=0;i<t;i++)a+='<span class="empty-span"></span>';return a}},{key:"countIndex",value:function(e){return e?e.length/4-2:0}},{key:"syncData",value:function(e,n){var t=this.container.find("#"+e);for(var a in n)t.data("treeData")[a]=n[a]}},{key:"onchangeBranch",value:function(e){}},{key:"openBranch",value:function(e){this.container.find("#children_"+e).removeClass("QTree-hide"),this.syncData(e,{open:!0})}},{key:"closeBranch",value:function(e){this.container.find("#children_"+e).addClass("QTree-hide"),this.syncData(e,{open:!1})}},{key:"setSwitchEvent",value:function(){var e=this;this.container.on("click",".switch",function(n){n.stopPropagation();var t=$(this).attr("data-switch"),a=$(this).parents(".QTree-branch").data("treeData").id;switch(t){case"true":e.closeBranch(a),$(this).attr("data-switch","false").removeClass("minus-btn").addClass("plus-btn");break;case"false":e.openBranch(a),$(this).attr("data-switch","true").removeClass("plus-btn").addClass("minus-btn")}})}},{key:"updateBranch",value:function(e,n){if("[object Object]"==Object.prototype.toString.call(n)){var t=this.container.find("#"+e);if(t.length){var a=t.data("treeData"),i={};for(var r in n)r in a&&n[r]!=a[r]&&(i[r]=n[r]);Object.keys(i).length&&(this.updateBranchData(t,i),this.syncData(e,i))}}}},{key:"updateBranchData",value:function(e,n){var t=this;e.children().each(function(e,a){for(var i in n)a.hasAttribute(i)&&(a.innerHTML=n[i]);$(a).children().length&&t.updateBranchData($(a),n)})}},{key:"removeBranch",value:function(e){var n=this.container.find("#container_"+e);console.log(n),n.length&&(n.remove(),this.checkSwitch(e,"del"))}},{key:"checkChlidren",value:function(e){return!!this.container.find("#children_"+e).children().length}},{key:"addBranch",value:function(e,n){if("id"in n){var t=$("#children_"+e),a=$("#"+e).length?$("#"+e).data("treeData").sortID:"",i=t.children.length+1;n.sortID=a+(1*i<10?"000"+i:1*i>100?"00"+i:1*i>1e3?i:"0"+i),n.open=!1;var r=this.createBranch(n);r.append(this.createBranchContainer(n.id,n.open)),t.append(r),this.checkSwitch(e,"add")}else console.error("add branch must need this branch's id")}},{key:"checkSwitch",value:function(e,n){switch(n){case"del":var t=$("#"+e).data("treeData").pid,a=$("#"+t);if(!this.checkChlidren(e)&&a.find(".switch").length){var i=this.createEmptySpan("000100010001");a.find(".switch").remove().end().prepend(i),$("#children_"+t).addClass("QTree-hide")}break;case"add":var r=$("#"+e);if(this.checkChlidren(e)&&!r.find(".switch").length){var c=this.createSwitchString(!1);r.find(".empty-span").last().after(c).remove()}}}},{key:"getTreeData",value:function(e){var n=[];return(e||0)&&n.push($("#"+e).data("treeData")),$("#children_"+e).find(".QTree-branch").each(function(e,t){n.push($(t).data("treeData"))}),n}},{key:"moveBranch",value:function(e,n){var t=this.getTreeData(e),a=$("#"+e);a.data("treeData").pid=n;var i=$("#container_"+e).clone(),r=a.data("treeData").sortID,c=$("#"+n),h=$("#children_"+e),s=c.data("treeData").sortID,d=this.countIndex(r)-this.countIndex(s);if(0!=d){if(d>0&&i.find(".QTree-branch").each(function(e,n){for(;d;)$(n).find(".empty-span").eq(0).remove(),d--}),d<0){var o=this.createEmptySpan(Math.abs(d),!0);i.find(".QTree-branch").prepend(o)}t.forEach(function(e){i.find("#"+e.id).data("treeData",e)}),h.append(i)}}}]),e}();