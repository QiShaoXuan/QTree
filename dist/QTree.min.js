"use strict";function _classCallCheck(n,e){if(!(n instanceof e))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function n(n,e){for(var t=0;t<e.length;t++){var a=e[t];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(n,a.key,a)}}return function(e,t,a){return t&&n(e.prototype,t),a&&n(e,a),e}}(),Qtree=function(){function n(e,t,a){_classCallCheck(this,n);var i={branchFormatter:'<div class="QTree-branch">\n                          <span class="tree-content name" name></span>\n                        </div>',renderData:["name"],openBranch:0,needLine:!0};this.setting=a?Object.assign(i,a):i,this.nodeData=t,this.container=$(e),this.init()}return _createClass(n,[{key:"init",value:function(){this.initData(),this.createTree(),this.setSwitchEvent()}},{key:"initData",value:function(){if(!this.nodeData.find(function(n){return 0==n.id})){this.nodeData.splice(0,0,{id:"0",pid:"",name:"root",open:!0})}this.setOpenBranchArr(),this.sortNodes(this.nodeData)}},{key:"setOpenBranchArr",value:function(){var n=Number(this.setting.openBranch);if(n||Math.floor(n)==n){var e=[];this.findOpenBranch(n,null,e),this.setting.openBranch=e}}},{key:"findOpenBranch",value:function(n,e,t){if(0==n)return t.push(n),"0";if(""!==e){if(e){var a=this.nodeData.find(function(n){return n.id===e});return t.push(a.id),this.findOpenBranch(n,a.pid,t)}var i=this.nodeData.find(function(e){return e.id==n});return t.push(n),i?this.findOpenBranch(n,i.pid,t):void 0}}},{key:"sortNodes",value:function(n){function e(n,i,r,c){n&&n.child.forEach(function(c,h){n.child[h].sortID=i+n.child[h].sortID,r.push(n.child[h]);var s=t.setting.openBranch.find(function(e){return e==n.child[h].id}),d=t.nodeData.find(function(e){return e.pid===n.child[h].id});void 0==s||void 0==d?0==n.child[h].id?n.child[h].open=!0:n.child[h].open=!1:n.child[h].open=!0,e(a[n.child[h].id],n.child[h].sortID,r)})}var t=this;!function(n){var i=[];e((a=function(n){if(n){for(var e={},t=0;t<n.length;t++)if(e[n[t].pid]){var a=1*e[n[t].pid].i+1;e[n[t].pid].i=a,n[t].sortID=1*a<10?"000"+a:1*a>100?"00"+a:1*a>1e3?a:"0"+a,e[n[t].pid].child.push(n[t])}else e[n[t].pid]={},e[n[t].pid].i=1,e[n[t].pid].child=[],n[t].sortID="0001",e[n[t].pid].child.push(n[t]);return e}}(n))[""],"",i),t.nodeData=i}(n=n);var a=null}},{key:"createTree",value:function(){var n=this,e=$(document.createDocumentFragment());this.nodeData.forEach(function(t,a){t.pid?(e.find(".children_"+t.pid).append(n.createBranch(t)),e.find(".container_"+t.id).append(n.createChildrenContainer(t.id,t.open))):e.append(n.createChildrenContainer(t.id,t.open,!0))}),this.container.empty().append(e)}},{key:"createChildrenContainer",value:function(n,e,t){var a=this.setting.needLine&&!t?" Qtree-line":"";return'<ul class="QTree-children-container children_'+n+" "+(e?"":"QTree-hide")+a+'"></ul>'}},{key:"createBranch",value:function(n){var e=$(this.setting.branchFormatter);e.data("treeData",n);var t=this.setting.needLine?"":this.createEmptySpan(n.sortID);this.loadBranchData(e,n);var a=this.createSwitch(n);e.prepend(a),e.prepend(t),e.addClass("branch_"+n.id),e.hasClass("QTree-branch")||e.addClass("QTree-branch");var i=$('<li class="QTree-branch-container container_'+n.id+(this.setting.needLine?" Qtree-line":"")+'"></li>');return i.append(e),i}},{key:"loadBranchData",value:function(n,e){var t=this,a=this;n.children().each(function(n,i){t.setting.renderData.forEach(function(n,t){i.hasAttribute(n)&&e[n]&&(i.innerHTML=e[n])}),$(i).children().length&&a.loadBranchData($(i),e)})}},{key:"hasChildren",value:function(n){return!!this.nodeData.find(function(e,t){return e.pid===n})}},{key:"createSwitch",value:function(n){return void 0!=this.nodeData.find(function(e){return e.pid==n.id})?this.createSwitchString(n.open):'<span class="empty-span"></span>'}},{key:"createSwitchString",value:function(n){return n?'<i class="switch minus-btn" data-switch="true"></i>':'<i class="switch plus-btn" data-switch="false"></i>'}},{key:"createEmptySpan",value:function(n,e){for(var t=e?n:this.countIndex(n),a="",i=0;i<t;i++)a+='<span class="empty-span"></span>';return a}},{key:"countIndex",value:function(n){return n?n.length/4-2:0}},{key:"syncData",value:function(n,e){var t=this.container.find(".branch_"+n);for(var a in e)a in t.data("treeData")&&(t.data("treeData")[a]=e[a])}},{key:"onchangeBranch",value:function(n){}},{key:"openBranch",value:function(n){if(0!=n){var e=this.container.find(".branch_"+n).data("treeData");this.container.find(".children_"+n).removeClass("QTree-hide"),this.syncData(n,{open:!0}),this.openBranch(e.pid)}}},{key:"closeBranch",value:function(n){this.container.find(".children_"+n).addClass("QTree-hide"),this.syncData(n,{open:!1})}},{key:"setSwitchEvent",value:function(){var n=this;this.container.on("click",".switch",function(e){e.stopPropagation();var t=$(this).attr("data-switch"),a=$(this).parents(".QTree-branch").data("treeData").id;switch(t){case"true":n.closeBranch(a),$(this).attr("data-switch","false").removeClass("minus-btn").addClass("plus-btn");break;case"false":n.openBranch(a),$(this).attr("data-switch","true").removeClass("plus-btn").addClass("minus-btn")}})}},{key:"updateBranch",value:function(n,e){if("[object Object]"==Object.prototype.toString.call(e)){var t=this.container.find(".branch_"+n);if(t.length){var a=t.data("treeData"),i={};for(var r in e)r in a&&e[r]!=a[r]&&(i[r]=e[r]);Object.keys(i).length&&(this.updateBranchData(t,i),this.syncData(n,i))}}}},{key:"updateBranchData",value:function(n,e){var t=this;n.children().each(function(n,a){for(var i in e)a.hasAttribute(i)&&(a.innerHTML=e[i]);$(a).children().length&&t.updateBranchData($(a),e)})}},{key:"removeBranch",value:function(n){var e=this.container.find(".container_"+n),t=this.container.find(".branch_"+n).data("treeData").pid;e.length&&(e.remove(),this.checkSwitch(t,"del"))}},{key:"checkChlidren",value:function(n){return!!this.container.find(".children_"+n).children().length}},{key:"addBranch",value:function(n,e){if("id"in e){var t=this.container.find(".children_"+n),a=this.container.find(".branch_"+n).length?this.container.find(".branch_"+n).data("treeData").sortID:"0001",i=t.children.length+1;e.sortID=a+(1*i<10?"000"+i:1*i>100?"00"+i:1*i>1e3?i:"0"+i),e.open=!1;var r=this.createBranch(e);r.append(this.createChildrenContainer(e.id,e.open)),t.append(r),this.checkSwitch(n,"add")}else console.error("add branch must need this branch's id")}},{key:"checkSwitch",value:function(n,e){if(this.container.find(".branch_"+n).length||0!=n)switch(e){case"del":var t=this.container.find(".branch_"+n);if(!this.checkChlidren(n)&&t.find(".switch").length){var a=this.setting.needLine?"":this.createEmptySpan(1,!0);t.find(".switch").remove().end().prepend(a),this.container.find(".children_"+n).addClass("QTree-hide")}break;case"add":var i=this.container.find(".branch_"+n);if(this.checkChlidren(n)&&!i.find(".switch").length){var r=this.createSwitchString(!1);i.find(".empty-span").last().after(r).remove()}}}},{key:"getTreeData",value:function(n){var e=[];return(n||0)&&e.push(this.container.find(".branch_"+n).data("treeData")),this.container.find(".children_"+n+" .QTree-branch").each(function(n,t){e.push($(t).data("treeData"))}),e}},{key:"moveBranch",value:function(n,e){var t=this.getTreeData(n),a=this.container.find(".branch_"+n),i=this.container.find(".container_"+n),r=""+a.data("treeData").pid;a.data("treeData").pid=e;var c=i.clone(),h=a.data("treeData").sortID,s=this.container.find(".branch_"+e),d=this.container.find(".children_"+e),o=s.data("treeData").sortID,l=this.countIndex(h)-this.countIndex(o);l>0&&c.find(".QTree-branch").each(function(n,e){for(;l;)$(e).find(".empty-span").eq(0).remove(),l--}),t.forEach(function(n){c.find(".branch_"+n.id).data("treeData",n)}),i.remove(),d.append(c),this.checkSwitch(r,"del"),this.checkSwitch(e,"add")}},{key:"closeAllBranch",value:function(){this.container.find(".children_0 .QTree-branch-container").each(function(n,e){$(e).find(".QTree-children-container").addClass("QTree-hide")})}},{key:"findParent",value:function(n){var e=this.container.find(".branch_"+n).data("treeData").pid;return{parentDom:this.container.find(".branch_"+e),parentContainer:this.container.find(".children_"+e)}}}]),n}();